import React, { useState, useEffect, useRef } from 'react';
import { 
  Server, 
  Monitor, 
  ArrowRight, 
  ArrowLeft, 
  Database, 
  Code, 
  Layers, 
  Activity, 
  CheckCircle, 
  Settings,
  Cpu,
  Globe,
  Binary,
  Play,
  RotateCcw,
  FileJson
} from 'lucide-react';

// --- Constants & Data ---

const STEPS = [
  {
    id: 'idl',
    title: '1. Interface Definition (IDL)',
    description: 'Everything starts with the .proto file. This defines the contract strictly typed and language agnostic.',
    code: `// greeter.proto
syntax = "proto3";

service Greeter {
  rpc SayHello (HelloRequest) returns (HelloReply) {}
}

message HelloRequest {
  string name = 1;
}

message HelloReply {
  string message = 1;
}`,
    explanation: "We define a Service 'Greeter' and a message 'HelloRequest'. The compiler (protoc) will generate the Java boilerplate from this."
  },
  {
    id: 'client_call',
    title: '2. Client Application Call',
    description: 'The Java client invokes the method on the generated Stub just like a local function call.',
    code: `// GrpcClient.java
ManagedChannel channel = ManagedChannelBuilder
    .forAddress("localhost", 8080)
    .usePlaintext()
    .build();

// The "Stub" looks like a local object
GreeterGrpc.GreeterBlockingStub stub = 
    GreeterGrpc.newBlockingStub(channel);

// Calling the method
HelloReply response = stub.sayHello(
    HelloRequest.newBuilder()
        .setName("Alice")
        .build()
);`,
    explanation: "The developer treats 'stub' like a normal Java object. Under the hood, the Stub is preparing to convert this object into network traffic."
  },
  {
    id: 'marshaling',
    title: '3. Marshaling (Serialization)',
    description: 'The Stub uses the Protobuf logic to serialize the Java Object into bytes. This is faster and smaller than JSON.',
    code: `// Generated Code (Hidden from user usually)
public void sayHello(HelloRequest request) {
  // Serializing to byte array
  byte[] data = request.toByteArray();
  
  // Tag 1 (Field 1) | Wire Type 2 (Length Delimited)
  // 0000 1010 (0x0A)
  // Length: 5
  // Value: "Alice" (UTF-8)
}`,
    visualData: { 
      type: 'serialization', 
      input: '{ name: "Alice" }', 
      output: '0A 05 41 6C 69 63 65' 
    },
    explanation: "Protobuf encodes 'name=1' as 0x0A (field 1, type string). Then the length (05), then 'Alice'. No field names are sent, saving massive bandwidth."
  },
  {
    id: 'framing',
    title: '4. HTTP/2 Framing',
    description: 'gRPC uses HTTP/2. The binary payload is wrapped in HTTP/2 Frames. This allows multiplexing multiple requests on one TCP connection.',
    code: `// NettyClientHandler.java (Abstracted)

// 1. HEADERS Frame (Stream ID: 1)
// :method = POST
// :scheme = http
// :path = /Greeter/SayHello
// content-type = application/grpc

// 2. DATA Frame (Stream ID: 1)
// [Compressed-Flag] [Length: 7] [Protobuf Bytes]`,
    explanation: "A 5-byte gRPC header is added (Compression flag + Length). Then it's wrapped in an HTTP/2 DATA frame. The HEADERS frame opens the stream."
  },
  {
    id: 'transport',
    title: '5. Network Transport',
    description: 'Frames travel over the wire. HTTP/2 ensures binary framing and header compression (HPACK).',
    visualData: { type: 'network' },
    code: `// Wire Representation
// Stream 1: [HEADERS Frame]
// Stream 1: [DATA Frame: 00 00 00 00 07 0A 05 41 6C 69 63 65]`,
    explanation: "Note the 00 00 00 00 07 prefix in the DATA frame. That is the gRPC preamble indicating the message is 7 bytes long and not compressed."
  },
  {
    id: 'server_receive',
    title: '6. Server Processing',
    description: 'The Server (Netty/ServerImpl) receives frames, reassembles the stream, and unmarshals the bytes back to a Java Object.',
    code: `// GreeterImpl.java
public class GreeterImpl extends GreeterImplBase {
  @Override
  public void sayHello(HelloRequest req, 
      StreamObserver<HelloReply> responseObserver) {
      
      // req.getName() is now "Alice"
      String message = "Hello " + req.getName();
      
      HelloReply reply = HelloReply.newBuilder()
          .setMessage(message)
          .build();
          
      responseObserver.onNext(reply);
      responseObserver.onCompleted();
  }
}`,
    explanation: "The server framework routes the path '/Greeter/SayHello' to this specific method implementation."
  },
  {
    id: 'response_path',
    title: '7. Response Path',
    description: 'The cycle reverses. The response is marshaled, framed, and sent back to the client.',
    code: `// Sending Response
// 1. HEADERS (:status = 200)
// 2. DATA (Length-Prefixed Protobuf "Hello Alice")
// 3. HEADERS (EOS, grpc-status = 0)`,
    explanation: "gRPC uses trailers (headers at the end) to send the status code. 'grpc-status: 0' means OK."
  }
];

// --- Components ---

const ByteBlock = ({ value, label, color = "bg-blue-500" }) => (
  <div className="flex flex-col items-center mx-1 animate-fade-in">
    <div className={`w-8 h-10 ${color} text-white font-mono text-xs flex items-center justify-center rounded shadow-sm border border-white/10`}>
      {value}
    </div>
    {label && <span className="text-[10px] text-gray-400 mt-1">{label}</span>}
  </div>
);

const Packet = ({ label, type, position }) => {
  const getPosition = () => {
    switch (position) {
      case 'client': return 'left-10 top-1/2';
      case 'mid-left': return 'left-1/3 top-1/2';
      case 'center': return 'left-1/2 top-1/2';
      case 'mid-right': return 'left-2/3 top-1/2';
      case 'server': return 'left-[90%] top-1/2';
      default: return 'left-10 top-1/2';
    }
  };

  return (
    <div 
      className={`absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-1000 ease-in-out z-20 flex flex-col items-center ${getPosition()}`}
    >
      <div className={`
        relative px-4 py-2 rounded-lg shadow-xl border 
        ${type === 'proto' ? 'bg-purple-900 border-purple-500 text-purple-100' : 
          type === 'http2' ? 'bg-green-900 border-green-500 text-green-100' : 'bg-blue-900 border-blue-500 text-blue-100'}
      `}>
        <div className="flex items-center gap-2">
          {type === 'proto' ? <Binary size={16} /> : <Globe size={16} />}
          <span className="font-mono text-sm font-bold">{label}</span>
        </div>
        {/* Decorative bits */}
        <div className="absolute -top-1 -right-1 w-2 h-2 bg-white rounded-full animate-ping opacity-75"></div>
      </div>
    </div>
  );
};

export default function GrpcSimulation() {
  const [currentStep, setCurrentStep] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  const scrollRef = useRef(null);

  const step = STEPS[currentStep];

  // Auto-play logic
  useEffect(() => {
    let interval;
    if (isPlaying) {
      interval = setInterval(() => {
        setCurrentStep((prev) => {
          if (prev >= STEPS.length - 1) {
            setIsPlaying(false);
            return prev;
          }
          return prev + 1;
        });
      }, 3500);
    }
    return () => clearInterval(interval);
  }, [isPlaying]);

  const handleReset = () => {
    setIsPlaying(false);
    setCurrentStep(0);
  };

  // Determine Packet State based on step
  const getPacketState = () => {
    if (currentStep < 2) return null;
    if (currentStep === 2) return { label: 'Protobuf Blob', type: 'proto', position: 'client' };
    if (currentStep === 3) return { label: 'HTTP/2 Frame', type: 'http2', position: 'client' };
    if (currentStep === 4) return { label: 'HTTP/2 Frame', type: 'http2', position: 'center' };
    if (currentStep === 5) return { label: 'Protobuf Blob', type: 'proto', position: 'server' };
    if (currentStep === 6) return { label: 'Response Frame', type: 'http2', position: 'mid-right' }; // Moving back
    return null;
  };

  const packet = getPacketState();

  return (
    <div className="flex flex-col h-screen bg-slate-950 text-slate-200 font-sans selection:bg-blue-500 selection:text-white overflow-hidden">
      
      {/* Header */}
      <header className="h-16 border-b border-slate-800 bg-slate-900/50 flex items-center justify-between px-6 backdrop-blur-md">
        <div className="flex items-center gap-3">
          <div className="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-900/20">
            <Activity size={20} className="text-white" />
          </div>
          <div>
            <h1 className="text-xl font-bold tracking-tight text-white">gRPC Architecture Simulator</h1>
            <p className="text-xs text-slate-400 font-mono">Protocol Buffers • HTTP/2 • Netty</p>
          </div>
        </div>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-2 px-3 py-1 bg-slate-800 rounded-full border border-slate-700">
            <div className={`w-2 h-2 rounded-full ${isPlaying ? 'bg-green-500 animate-pulse' : 'bg-slate-500'}`}></div>
            <span className="text-xs font-mono text-slate-400">{isPlaying ? 'SIMULATION RUNNING' : 'IDLE'}</span>
          </div>
        </div>
      </header>

      {/* Main Content Grid */}
      <main className="flex-1 grid grid-cols-12 gap-0 overflow-hidden">
        
        {/* LEFT PANEL: Interactive Visualizer */}
        <div className="col-span-7 flex flex-col border-r border-slate-800 relative bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-slate-950">
          
          {/* Visual Stage */}
          <div className="flex-1 relative flex items-center justify-center p-8 overflow-hidden">
            
            {/* Background Grid */}
            <div className="absolute inset-0 bg-[linear-gradient(rgba(30,41,59,0.3)_1px,transparent_1px),linear-gradient(90deg,rgba(30,41,59,0.3)_1px,transparent_1px)] bg-[size:40px_40px] opacity-20 pointer-events-none"></div>

            {/* Client Node */}
            <div className={`absolute left-10 top-1/2 -translate-y-1/2 w-48 h-64 border-2 ${currentStep < 5 ? 'border-blue-500 shadow-[0_0_30px_rgba(59,130,246,0.2)]' : 'border-slate-700 opacity-50'} bg-slate-900/80 rounded-xl flex flex-col p-4 transition-all duration-500 z-10 backdrop-blur`}>
              <div className="flex items-center gap-2 mb-4 text-blue-400">
                <Monitor size={20} />
                <span className="font-bold">Java Client</span>
              </div>
              <div className="flex-1 flex flex-col gap-2 font-mono text-xs">
                <div className={`p-2 rounded border ${currentStep === 1 ? 'bg-blue-900/30 border-blue-500/50' : 'border-transparent'}`}>
                  Application Logic
                </div>
                <div className={`p-2 rounded border ${currentStep === 2 ? 'bg-purple-900/30 border-purple-500/50' : 'border-transparent'}`}>
                  Stub (Marshaling)
                </div>
                <div className={`p-2 rounded border ${currentStep === 3 ? 'bg-green-900/30 border-green-500/50' : 'border-transparent'}`}>
                  Netty Channel
                </div>
              </div>
            </div>

            {/* Connection Pipe */}
            <div className="absolute left-[200px] right-[200px] top-1/2 h-4 bg-slate-800 rounded-full overflow-hidden">
               {/* Data flow animation */}
               {(currentStep >= 3 && currentStep <= 6) && (
                 <div className="w-full h-full bg-gradient-to-r from-transparent via-blue-500/50 to-transparent animate-shimmer" style={{ backgroundSize: '200% 100%' }}></div>
               )}
            </div>

            {/* Server Node */}
            <div className={`absolute right-10 top-1/2 -translate-y-1/2 w-48 h-64 border-2 ${currentStep >= 5 ? 'border-emerald-500 shadow-[0_0_30px_rgba(16,185,129,0.2)]' : 'border-slate-700 opacity-50'} bg-slate-900/80 rounded-xl flex flex-col p-4 transition-all duration-500 z-10 backdrop-blur`}>
              <div className="flex items-center gap-2 mb-4 text-emerald-400">
                <Server size={20} />
                <span className="font-bold">Java Server</span>
              </div>
              <div className="flex-1 flex flex-col gap-2 font-mono text-xs">
                <div className={`p-2 rounded border ${currentStep === 5 ? 'bg-green-900/30 border-green-500/50' : 'border-transparent'}`}>
                  Netty Server
                </div>
                <div className={`p-2 rounded border ${currentStep === 5 ? 'bg-purple-900/30 border-purple-500/50' : 'border-transparent'}`}>
                  Service (Unmarshal)
                </div>
                <div className={`p-2 rounded border ${currentStep === 6 ? 'bg-emerald-900/30 border-emerald-500/50' : 'border-transparent'}`}>
                  Implementation
                </div>
              </div>
            </div>

            {/* The Moving Packet */}
            {packet && <Packet label={packet.label} type={packet.type} position={packet.position} />}

            {/* Protocol Details Visualization (Contextual) */}
            <div className="absolute bottom-8 left-0 right-0 flex justify-center">
              {currentStep === 2 && (
                <div className="bg-slate-900 border border-slate-700 p-4 rounded-lg flex items-center gap-4 animate-slide-up shadow-2xl">
                  <div className="text-xs font-mono text-slate-400 mb-2 absolute -top-3 left-4 bg-slate-900 px-2">Serialization View</div>
                  <div className="flex gap-1">
                    <ByteBlock value="0A" label="Tag (1, String)" color="bg-purple-600" />
                    <ByteBlock value="05" label="Length" color="bg-blue-600" />
                    <ByteBlock value="41" label="A" color="bg-slate-600" />
                    <ByteBlock value="6C" label="l" color="bg-slate-600" />
                    <ByteBlock value="69" label="i" color="bg-slate-600" />
                    <ByteBlock value="63" label="c" color="bg-slate-600" />
                    <ByteBlock value="65" label="e" color="bg-slate-600" />
                  </div>
                </div>
              )}
              {currentStep === 3 && (
                <div className="bg-slate-900 border border-slate-700 p-4 rounded-lg flex flex-col gap-2 animate-slide-up shadow-2xl">
                   <div className="text-xs font-mono text-slate-400 mb-1 absolute -top-3 left-4 bg-slate-900 px-2">HTTP/2 Frame View</div>
                   <div className="flex items-center gap-2">
                      <span className="text-xs font-mono text-green-400">HEADERS</span>
                      <div className="h-6 px-2 bg-green-900/50 border border-green-700 rounded flex items-center text-xs font-mono text-green-200">
                        :method: POST
                      </div>
                      <div className="h-6 px-2 bg-green-900/50 border border-green-700 rounded flex items-center text-xs font-mono text-green-200">
                        :path: /Greeter/SayHello
                      </div>
                   </div>
                   <div className="flex items-center gap-2 mt-2">
                      <span className="text-xs font-mono text-blue-400">DATA</span>
                      <div className="h-8 px-2 bg-blue-900/50 border border-blue-700 rounded flex items-center gap-1">
                         <div className="w-4 h-4 bg-yellow-500 rounded-sm text-[8px] flex items-center justify-center text-black font-bold" title="Compression Flag">0</div>
                         <div className="w-8 h-4 bg-indigo-500 rounded-sm text-[8px] flex items-center justify-center text-white" title="Length Prefix">00..07</div>
                         <div className="w-16 h-4 bg-purple-500 rounded-sm text-[8px] flex items-center justify-center text-white">PROTOBUF</div>
                      </div>
                   </div>
                </div>
              )}
            </div>

          </div>

          {/* Timeline Controls */}
          <div className="h-24 bg-slate-900 border-t border-slate-800 p-4 flex items-center justify-between z-20">
             <div className="flex items-center gap-2">
                <button 
                  onClick={handleReset}
                  className="p-2 rounded hover:bg-slate-800 text-slate-400 hover:text-white transition-colors"
                >
                  <RotateCcw size={18} />
                </button>
                <button 
                  onClick={() => setIsPlaying(!isPlaying)}
                  className="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-md font-medium transition-all shadow-lg shadow-blue-900/20 active:scale-95"
                >
                  {isPlaying ? (
                    <>
                       <div className="w-3 h-3 bg-white rounded-sm"></div>
                       <span>Pause</span>
                    </>
                  ) : (
                    <>
                       <Play size={16} fill="currentColor" />
                       <span>Simulate</span>
                    </>
                  )}
                </button>
             </div>

             {/* Stepper Dots */}
             <div className="flex items-center gap-4">
                <button 
                  disabled={currentStep === 0}
                  onClick={() => {setIsPlaying(false); setCurrentStep(Math.max(0, currentStep - 1))}}
                  className="text-slate-500 hover:text-white disabled:opacity-30"
                >
                  <ArrowLeft size={20} />
                </button>
                <div className="flex items-center gap-2">
                  {STEPS.map((s, idx) => (
                    <div 
                      key={s.id} 
                      className={`
                        w-3 h-3 rounded-full transition-all duration-300
                        ${idx === currentStep ? 'bg-blue-500 scale-125' : idx < currentStep ? 'bg-blue-900' : 'bg-slate-800'}
                      `} 
                    />
                  ))}
                </div>
                <button 
                  disabled={currentStep === STEPS.length - 1}
                  onClick={() => {setIsPlaying(false); setCurrentStep(Math.min(STEPS.length - 1, currentStep + 1))}}
                  className="text-slate-500 hover:text-white disabled:opacity-30"
                >
                  <ArrowRight size={20} />
                </button>
             </div>
          </div>
        </div>

        {/* RIGHT PANEL: Code & Docs */}
        <div className="col-span-5 bg-slate-950 flex flex-col h-full overflow-hidden">
          
          {/* Info Header */}
          <div className="p-6 border-b border-slate-800 bg-slate-900/30">
            <h2 className="text-2xl font-bold text-white mb-2 flex items-center gap-3">
              <span className="flex items-center justify-center w-8 h-8 rounded-full bg-blue-600 text-sm">{currentStep + 1}</span>
              {step.title}
            </h2>
            <p className="text-slate-400 leading-relaxed">
              {step.description}
            </p>
          </div>

          {/* Deep Dive Section */}
          <div className="flex-1 overflow-y-auto p-0 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent">
            
            {/* Engineer's Note */}
            <div className="p-6 bg-slate-900/50 border-b border-slate-800">
               <div className="flex items-start gap-3">
                 <div className="mt-1">
                    <CheckCircle size={18} className="text-emerald-500" />
                 </div>
                 <div>
                    <h3 className="text-sm font-bold text-emerald-400 mb-1 uppercase tracking-wider">Engineer's Insight</h3>
                    <p className="text-sm text-slate-300 leading-relaxed">
                      {step.explanation}
                    </p>
                 </div>
               </div>
            </div>

            {/* Code Block */}
            <div className="p-6">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-2 text-slate-400 text-sm font-mono">
                  <Code size={14} />
                  <span>
                    {currentStep === 0 ? 'greeter.proto' : 
                     currentStep === 1 ? 'GrpcClient.java' : 
                     currentStep === 3 ? 'Internal/Netty' : 
                     currentStep === 6 ? 'GreeterImpl.java' : 'Generated Code'}
                  </span>
                </div>
                <div className="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Java / Pseudo-code</div>
              </div>
              
              <div className="relative group">
                <div className="absolute -inset-1 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg blur opacity-25 group-hover:opacity-40 transition duration-1000 group-hover:duration-200"></div>
                <div className="relative bg-slate-900 rounded-lg border border-slate-800 p-4 font-mono text-sm leading-relaxed overflow-x-auto shadow-inner">
                  <pre className="text-blue-100">
                    {step.code}
                  </pre>
                </div>
              </div>

              {/* Advanced Stats / Data Table if available */}
              {step.visualData && (
                <div className="mt-6 bg-slate-900/50 rounded-lg border border-slate-800 p-4">
                  <h4 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                    <Settings size={12} />
                    Internal State
                  </h4>
                  <div className="space-y-2">
                    {Object.entries(step.visualData).map(([k, v]) => (
                      <div key={k} className="flex justify-between text-xs font-mono border-b border-slate-800/50 pb-1 last:border-0">
                        <span className="text-slate-400">{k}</span>
                        <span className="text-emerald-400">{v}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
            
            <div className="h-20"></div> {/* Spacer */}
          </div>
        </div>

      </main>

      <style>{`
        @keyframes shimmer {
          0% { transform: translateX(-100%); }
          100% { transform: translateX(100%); }
        }
        .animate-shimmer {
          animation: shimmer 2s infinite linear;
        }
        @keyframes fade-in {
          0% { opacity: 0; transform: translateY(10px); }
          100% { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
          animation: fade-in 0.5s ease-out forwards;
        }
        @keyframes slide-up {
          0% { opacity: 0; transform: translateY(20px); }
          100% { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up {
          animation: slide-up 0.5s ease-out forwards;
        }
      `}</style>
    </div>
  );
}
